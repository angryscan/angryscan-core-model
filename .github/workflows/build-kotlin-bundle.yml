# Builds modelaudit binary for Mac, Linux, Windows and merges into one JAR.
# Optional: publish to Maven Central (on release or when workflow_dispatch with publish_to_maven_central=true).
# Required repo secrets for publish:
#   SONATYPE_USERNAME, SONATYPE_PASSWORD â€” must be Central Portal User Token (from https://central.sonatype.com/usertoken).
#     Generate token there and use the token's username and password; legacy OSSRH login causes 401.
#   SIGNING_KEY_ID, SIGNING_PASSWORD, SIGNING_SECRET_KEY_RING_BASE64 (base64 of gpg --export-secret-keys KEY_ID > secring.gpg).
name: Build Kotlin bundled binaries

on:
  workflow_dispatch:
    inputs:
      publish_to_maven_central:
        description: 'Publish to Maven Central (requires secrets)'
        required: false
        default: false
        type: boolean
  push:
    branches: [main]
    paths:
      - 'modelaudit/**'
      - 'scripts/build_bundle.py'
      - 'scripts/standalone_entry.py'
      - 'modelaudit-kotlin/**'
      - 'pyproject.toml'
      - '.github/workflows/build-kotlin-bundle.yml'
  release:
    types: [published]

permissions:
  contents: read

jobs:
  build-bundle:
    name: Bundle ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-22.04
            os: linux
          - runner: macos-14
            os: macos
          - runner: windows-latest
            os: windows
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/lib/node_modules
          sudo rm -rf /opt/microsoft
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/julia*
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/local/share/heroku
          sudo rm -rf /opt/az
          sudo rm -rf /usr/local/share/miniconda*
          sudo rm -rf /usr/local/share/phantomjs
          sudo rm -rf /usr/local/share/sbt
          sudo rm -rf /usr/local/share/gradle
          sudo rm -rf /usr/local/share/apache-maven-*
          sudo rm -rf /usr/local/share/ant
          sudo rm -rf /usr/local/share/cmake
          sudo rm -rf /usr/local/share/rustup
          sudo rm -rf /usr/local/share/pyenv
          sudo rm -rf /usr/local/share/graalvm
          sudo rm -rf /usr/local/share/playwright
          sudo rm -rf /usr/local/share/playwright-browsers
          sudo apt-get clean
          sudo docker image prune --all --force 2>/dev/null || true
          df -h

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set Python 3.12
        run: uv python pin 3.12

      - name: "Install dependencies (bundle only: PyInstaller + base deps; no all-ci to keep artifact small)"
        run: uv sync --extra bundle

      - name: Build standalone binary
        run: uv run python scripts/build_bundle.py

      - name: Free disk after build (keep only bins for artifact)
        if: runner.os != 'Windows'
        run: |
          rm -rf .venv build-bundle dist-bundle
          df -h

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v6
        with:
          name: bins-${{ matrix.os }}-${{ runner.arch }}
          path: modelaudit-kotlin/src/main/resources/io/modelaudit/bins/

  merge-and-jar:
    name: Merge bins and build JAR
    needs: build-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download all bundle artifacts
        uses: actions/download-artifact@v7
        with:
          path: bins-artifacts
          pattern: bins-*

      - name: Merge bins into resources
        run: |
          BINS_ROOT="modelaudit-kotlin/src/main/resources/io/modelaudit/bins"
          mkdir -p "$BINS_ROOT"
          for dir in bins-artifacts/bins-*; do
            if [ -d "$dir" ]; then
              for platform in "$dir"/*; do
                if [ -d "$platform" ]; then
                  name=$(basename "$platform")
                  mkdir -p "$BINS_ROOT/$name"
                  cp -R "$platform"/* "$BINS_ROOT/$name/"
                fi
              done
            fi
          done
          echo "Bundled platforms:"
          ls -la "$BINS_ROOT"

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Build Kotlin JAR (use merged bins from all platforms; skip local bundle build)
        run: ./gradlew :modelaudit-kotlin:jar -PskipBundleBuild --no-daemon

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v6
        with:
          name: modelaudit-kotlin-jar
          path: modelaudit-kotlin/build/libs/modelaudit-kotlin-*.jar

  publish:
    name: Publish to Maven Central (all platforms)
    needs: merge-and-jar
    if: github.event_name == 'release' && github.event.action == 'published' || github.event.inputs.publish_to_maven_central == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Download all bundle artifacts
        uses: actions/download-artifact@v7
        with:
          path: bins-artifacts
          pattern: bins-*

      - name: Merge bins into resources
        run: |
          BINS_ROOT="modelaudit-kotlin/src/main/resources/io/modelaudit/bins"
          mkdir -p "$BINS_ROOT"
          for dir in bins-artifacts/bins-*; do
            if [ -d "$dir" ]; then
              for platform in "$dir"/*; do
                if [ -d "$platform" ]; then
                  name=$(basename "$platform")
                  mkdir -p "$BINS_ROOT/$name"
                  cp -R "$platform"/* "$BINS_ROOT/$name/"
                fi
              done
            fi
          done
          echo "Bundled platforms:"
          ls -la "$BINS_ROOT"

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Create signing keyring from secret
        env:
          SIGNING_SECRET_KEY_RING_BASE64: ${{ secrets.SIGNING_SECRET_KEY_RING_BASE64 }}
        run: |
          echo "$SIGNING_SECRET_KEY_RING_BASE64" | base64 -d > "$RUNNER_TEMP/secring.gpg"

      - name: Publish to Maven Central
        env:
          # Central Portal User Token (https://central.sonatype.com/usertoken), not legacy OSSRH login
          ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_signing_keyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signing_password: ${{ secrets.SIGNING_PASSWORD }}
        run: ./gradlew publishToMavenCentral -PskipBundleBuild --no-daemon -Psigning.secretKeyRingFile=$RUNNER_TEMP/secring.gpg
